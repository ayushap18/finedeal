(()=>{"use strict";const e={amazon:{name:"Amazon",badge:"amazon-badge",searchUrl:"https://www.amazon.in/s?k=",enabled:!0,priority:1,selectors:{productPage:{title:["#productTitle","h1.product-title","span#productTitle"],price:[".a-price-whole",".a-price .a-offscreen","span.a-price-whole",".a-price-range .a-price .a-offscreen"],image:["#landingImage",".a-dynamic-image","img#landingImage"],productId:["[data-asin]"],brand:["#bylineInfo",".a-size-base.po-break-word","a#bylineInfo"]},searchPage:{container:['div[data-component-type="s-search-result"]','div[data-asin]:not([data-asin=""])'],title:["h2 a span","h2 span.a-text-normal",".a-text-normal","h2.a-size-mini span"],price:[".a-price-whole","span.a-price-whole",".a-price .a-offscreen"],image:["img.s-image","img[data-image-latency]"],link:["h2 a","a.a-link-normal.s-no-outline"],productId:["[data-asin]"]}}},flipkart:{name:"Flipkart",badge:"flipkart-badge",searchUrl:"https://www.flipkart.com/search?q=",enabled:!0,priority:2,selectors:{productPage:{title:["span.VU-ZEz",".VU-ZEz",".B_NuCI","h1.B_NuCI","span.B_NuCI","h1",'[class*="title"]'],price:["div.Nx9bqj.CxhGGd",".Nx9bqj.CxhGGd","div.Nx9bqj",".Nx9bqj","._30jeq3","._16Jk6d",'[class*="price"]'],image:["._396cs4","._53J4C- img",".CXW8mj img","._396cs4 img",'img[class*="image"]'],productId:["[data-id]","[data-tkid]","[data-product-id]"],brand:["span._1Us2sh","._1Us2sh",".fMghEO span",".fMghEO"]},searchPage:{container:["div[data-id]","._1AtVbE","._13oc-S","div._1xHGtK",'[class*="product"]'],title:[".KzDlHZ","a.KzDlHZ",".s1Q9rs","a.s1Q9rs","._2WkVRV","a.IRpwTa",'[class*="title"]'],price:[".Nx9bqj","div.Nx9bqj","._30jeq3","div._30jeq3","._3tbKJL",'[class*="price"]'],image:["img._2r_T1I","img._396cs4",'img[class*="image"]',"img"],link:["a._1fQZEK","a.s1Q9rs","a._2rpwqI","a.IRpwTa",'a[href*="/p/"]',"a"]}}},myntra:{name:"Myntra",badge:"myntra-badge",searchUrl:"https://www.myntra.com/search?q=",enabled:!1,priority:3,selectors:{productPage:{title:[".pdp-title",".pdp-name","h1.pdp-name","h1.pdp-title",'[class*="pdp-title"]','[class*="pdp-name"]',"h1"],price:[".pdp-price",".pdp-price strong","span.pdp-price",".pdp-mrp",'[class*="pdp-price"]','[class*="pdp-mrp"]'],image:[".image-grid-image","img.image-grid-image",".pdp-image",'img[class*="image-grid"]',"img"],productId:["[data-productid]","[data-product-id]","[data-skuid]"],brand:[".pdp-title",".pdp-brand","h1.pdp-brand",'[class*="brand"]','[class*="pdp-brand"]']},searchPage:{container:[".product-base","li.product-base",".product-productMetaInfo",'[class*="product-base"]','li[class*="product"]'],title:[".product-brand",".product-product",".product-productMetaInfo h3","h3.product-brand","h4.product-product",'[class*="product-brand"]'],price:[".product-discountedPrice",".product-price","span.product-discountedPrice","div.product-price",'[class*="discounted"]','[class*="price"]'],image:["img.img-responsive",'img[class*="img-responsive"]',"picture img","img"],link:["a",'a[href*="/"]','[class*="product"] a'],productId:["[data-productid]","[data-product-id]","[data-skuid]"]}}},snapdeal:{name:"Snapdeal",badge:"snapdeal-badge",searchUrl:"https://www.snapdeal.com/search?keyword=",enabled:!0,priority:4,selectors:{productPage:{title:[".pdp-e-i-head","h1.pdp-e-i-head",".title-section h1",'[itemprop="name"]',"h1",'[class*="pdp-e-i-head"]'],price:[".pdp-final-price",".payBlkBig","span.payBlkBig",".pdp-e-i-price",'[class*="final-price"]','[class*="payBlk"]'],image:["#bx-img","img#bx-img",".mainImageWrapper img",".product-image img",'img[itemprop="image"]',"img"],productId:["[data-productid]","[data-product-id]",'[id*="product"]',"[data-pid]"],brand:['[itemprop="brand"]',".h2",".pdp-e-i-brand",'[class*="brand"]']},searchPage:{container:[".product-tuple-listing","div.product-tuple-listing",".col-xs-6",'[class*="product-tuple"]',".product"],title:[".product-title","p.product-title",".prodName","[title]",'[class*="title"]'],price:[".product-price","span.product-price",".lfloat",'[class*="price"]'],image:["img.product-image","source[srcset]","picture img","img"],link:['a[href*="/product/"]',"a.dp-widget-link",".product-tuple-listing a","a"],productId:["[data-productid]","[data-product-id]",'[id*="product"]',"[data-pid]"]}}},tatacliq:{name:"Tata CLiQ",badge:"tatacliq-badge",searchUrl:"https://www.tatacliq.com/search/?searchCategory=all&text=",enabled:!0,priority:5,selectors:{productPage:{title:["h1.ProductDetailsMainCard__productName",".ProductDetailsMainCard__productName",'[class*="productName"]',"h1",'[class*="title"]'],price:[".ProductDetailsMainCard__price","span.ProductDetailsMainCard__price",'[class*="price"]'],image:[".ProductDetailsMainCard__productImage",'img[class*="productImage"]',"picture img","img"],productId:["[data-productid]","[data-product-id]","[data-sku]"],brand:[".ProductDetailsMainCard__brandName",'[class*="brandName"]','[class*="brand"]']},searchPage:{container:[".ProductModule__base",'div[class*="ProductModule"]',".SearchModule__listingContainer > div",'[class*="product"]'],title:[".ProductModule__productTitle",".ProductDescription__title",'[class*="productTitle"]',"h2","h3"],price:[".ProductDescription__priceHolder",".ProductPrice__price",'[class*="price"]','span[class*="price"]'],image:['img[class*="ProductModule"]',"picture img","img"],link:['a[href*="/"]','a[class*="ProductModule"]',"a"],productId:["[data-productid]","[data-product-id]","[data-sku]"]}}},ajio:{name:"Ajio",badge:"ajio-badge",searchUrl:"https://www.ajio.com/search/?text=",enabled:!0,priority:6,selectors:{productPage:{title:[".prod-title","h1.prod-title",".pdp-title",'[class*="prod-title"]',"h1"],price:[".prod-sp","span.prod-sp",".prod-price",'[class*="prod-sp"]','[class*="price"]'],image:[".prod-image-container img",'img[class*="prod-image"]',"picture img","img"],productId:["[data-productid]","[data-product-code]","[data-sku]"],brand:[".prod-brand",'span[class*="brand"]','[class*="brand"]']},searchPage:{container:[".item",".rilrtl-products-list__item",'div[class*="item"]','[class*="product"]'],title:[".nameCls",".name",".product-name",'div[class*="name"]','[class*="title"]'],price:[".price","span.price",'[class*="discounted"]','[class*="price"]'],image:['img[class*="img"]',"picture img","img"],link:['a[href*="/p/"]','a[class*="product"]',"a"],productId:["[data-productid]","[data-product-code]","[data-sku]"]}}},nykaa:{name:"Nykaa",badge:"nykaa-badge",searchUrl:"https://www.nykaa.com/search/result/?q=",enabled:!0,priority:7,selectors:{productPage:{title:[".product-title",'h1[class*="product"]',"h1",'[class*="title"]'],price:[".product-price",'span[class*="price"]','[class*="offer-price"]','[class*="price"]'],image:[".product-image",'img[class*="product"]',"picture img","img"],productId:["[data-productid]","[data-product-id]","[data-id]"],brand:[".product-brand",'[class*="brand"]']},searchPage:{container:[".css-xrzmfa",".productWrapper",'div[class*="product"]',"article"],title:[".css-1jnyxt6","h2",'[class*="title"]','span[class*="title"]'],price:[".css-111z9ua",'span[class*="price"]','[class*="price"]'],image:['img[class*="css"]',"picture img","img"],link:['a[href*="/"]',"a"],productId:["[data-productid]","[data-product-id]","[data-id]"]}}},croma:{name:"Croma",badge:"croma-badge",searchUrl:"https://www.croma.com/searchB?q=",enabled:!0,priority:8,selectors:{productPage:{title:[".pd-title",'h1[class*="title"]',"h1",'[class*="product-title"]'],price:[".amount","span.amount",".new-price",'[class*="price"]','[class*="amount"]'],image:[".product-image",'img[class*="product"]',"picture img","img"],productId:["[data-product-id]","[data-productid]","[data-sku]"],brand:[".pd-brand",'[class*="brand"]']},searchPage:{container:[".product-item",".plp-card",'div[class*="product"]',"article"],title:[".product-title","h3",'[class*="title"]'],price:[".amount",".new-price",'span[class*="price"]','[class*="price"]'],image:['img[class*="product"]',"picture img","img"],link:['a[href*="/"]',"a"],productId:["[data-product-id]","[data-productid]","[data-sku]"]}}},vijaysales:{name:"Vijay Sales",badge:"vijaysales-badge",searchUrl:"https://www.vijaysales.com/search/",enabled:!0,priority:9,selectors:{productPage:{title:[".product-name",'h1[class*="product"]',"h1",'[class*="title"]'],price:[".price","span.price",".regular-price",'[class*="price"]'],image:[".product-image",'img[class*="product"]',"picture img","img"],productId:["[data-product-id]","[data-productid]","[data-sku]"],brand:[".product-brand",'[class*="brand"]']},searchPage:{container:[".product-item",".product-layout",".product-thumb",'div[class*="product"]',"article"],title:[".product-name","h4",'[class*="name"]','[class*="title"]'],price:[".price-new",".price",'span[class*="price"]','[class*="price"]'],image:['img[class*="img"]',"picture img","img"],link:['a[href*="/"]',"a"],productId:["[data-product-id]","[data-productid]","[data-sku]"]}}}};function t(){return Object.entries(e).filter(([e,t])=>t.enabled).sort((e,t)=>e[1].priority-t[1].priority).map(([e])=>e)}var r,a;function i(e,t="‚Çπ"){return`${t}${e.toLocaleString("en-IN")}`}function s(e,t){const r=e-t,a=Math.abs(Math.round(r/e*100));return{diff:Math.abs(r),percent:a,isCheaper:r>0}}function o(e){const t=[/(iphone\s*\d+[a-z]*(?:\s+pro)?(?:\s+max)?(?:\s+plus)?(?:\s+mini)?)/i,/(galaxy\s+[a-z]\d+\s*(?:pro|plus|ultra)?)/i,/(oneplus\s+\d+[a-z]*(?:\s+pro)?(?:\s+r)?(?:\s+t)?)/i,/(pixel\s+\d+[a-z]*(?:\s+pro)?(?:\s+xl)?)/i,/((?:redmi|mi)\s+\d+[a-z]*(?:\s+pro)?)/i,/(nitro\s+(?:v\s+)?\d+|aspire\s+\d+|predator\s+\w+\s+\d+|swift\s+\d+)/i,/(tuf\s+[a-z]\d+|rog\s+\w+\s+[a-z]?\d+|vivobook\s+\d+|zenbook\s+\d+)/i,/(pavilion\s+\d+|omen\s+\d+|victus\s+\d+|envy\s+\d+)/i,/(xps\s+\d+|g\d+|inspiron\s+\d+|vostro\s+\d+|latitude\s+\d+)/i,/(loq\s+\d+|ideapad\s+(?:gaming\s+)?\d+|thinkpad\s+[a-z]\d+|legion\s+\d+)/i,/(gf\d+|katana\s+\d+|bravo\s+\d+|pulse\s+\d+)/i,/\b([a-z]{1,3}\d{2,4}[a-z]?)\b/i];for(const r of t){const t=e.match(r);if(t)return t[1].trim()}return""}function n(e){const t=e.match(/\b(\d+)\s*(gb|tb)\b/i);return t?`${t[1]}${t[2].toUpperCase()}`:""}function c(e){const t=e.match(/\b(\d+)\s*gb\s+ram\b/i);return t?`${t[1]}GB`:""}function l(e){const t=["black","white","blue","red","green","yellow","pink","purple","gray","grey","silver","gold","rose","titanium","midnight","starlight","navy","maroon","beige","brown","orange"],r=e.toLowerCase();for(const e of t)if(r.includes(e))return e.charAt(0).toUpperCase()+e.slice(1);return""}!function(e){e.EXACT_ID="EXACT_ID",e.EXACT="EXACT",e.HIGH="HIGH",e.MEDIUM="MEDIUM",e.LOW="LOW",e.SIMILAR="SIMILAR"}(r||(r={})),function(e){e.NETWORK_ERROR="NETWORK_ERROR",e.SCRAPE_ERROR="SCRAPE_ERROR",e.MATCH_ERROR="MATCH_ERROR",e.INVALID_PRODUCT="INVALID_PRODUCT",e.TIMEOUT="TIMEOUT",e.RATE_LIMIT="RATE_LIMIT"}(a||(a={}));const d={Apple:["iphone","ipad","macbook","airpods","apple"],Samsung:["samsung","galaxy"],Xiaomi:["xiaomi","mi","redmi","poco"],OnePlus:["oneplus","one plus"],Realme:["realme","real me"],Oppo:["oppo"],Vivo:["vivo"],Google:["google","pixel"],HP:["hp","hewlett-packard","hewlett packard"],Dell:["dell"],Lenovo:["lenovo"],Asus:["asus"],Acer:["acer"],MSI:["msi"],Sony:["sony"],LG:["lg"],Philips:["philips"],Panasonic:["panasonic"],Whirlpool:["whirlpool"],Bosch:["bosch"],IFB:["ifb"],Canon:["canon"],Nikon:["nikon"],Nike:["nike"],Adidas:["adidas"],Puma:["puma"],Reebok:["reebok"],Levis:["levi","levis","levi's"],Zara:["zara"],"H&M":["h&m","hm","h and m"],Mango:["mango"],UCB:["ucb","united colors of benetton","benetton"],"Allen Solly":["allen solly","allensolly"],"Van Heusen":["van heusen","vanheusen"],Lakme:["lakme","lakm√©"],Maybelline:["maybelline"],"L'Oreal":["loreal","l'oreal","l oreal"],MAC:["mac"],Revlon:["revlon"],Nykaa:["nykaa"],Mamaearth:["mamaearth","mama earth"],Boat:["boat","boAt"],JBL:["jbl"],Bose:["bose"],Sennheiser:["sennheiser"],Fastrack:["fastrack","fast track"],Titan:["titan"],Casio:["casio"],Fossil:["fossil"],Timex:["timex"]};function p(e){if(!e)return"";const t=e.toLowerCase().trim();for(const[e,r]of Object.entries(d))if(e.toLowerCase()===t)return e;for(const[e,r]of Object.entries(d))if(r.some(e=>e.toLowerCase()===t))return e;return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}function u(e,t){if(!e||!t)return!1;const r=p(e),a=p(t);return r.toLowerCase()===a.toLowerCase()}function h(e,t){if(!e.productNumber||!t.productNumber)return!1;if(e.productNumber===t.productNumber)return!0;if(e.asin&&e.asin===t.asin)return!0;if(e.sku&&e.sku===t.sku)return!0;if(e.partNumber&&e.partNumber===t.partNumber)return!0;if(e.modelNumber&&e.modelNumber===t.modelNumber)return!0;const r=e.productNumber.replace(/[\s\-]/g,"").toUpperCase(),a=t.productNumber.replace(/[\s\-]/g,"").toUpperCase();return r===a||!!(r.length>=6&&a.length>=6&&(r.includes(a)||a.includes(r)))}var m;!function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR"}(m||(m={}));const g=new class{constructor(e="FineDeal"){this.level=m.INFO,this.prefix=e,this.initializeLogLevel()}async initializeLogLevel(){try{if(chrome?.storage){const e=await chrome.storage.local.get(["logLevel"]);this.level=e.logLevel??m.INFO}}catch{}}setLevel(e){this.level=e;try{chrome?.storage&&chrome.storage.local.set({logLevel:e})}catch{}}debug(e,...t){this.level<=m.DEBUG&&console.log(`[${this.prefix}] üêõ ${e}`,...t)}info(e,...t){this.level<=m.INFO&&console.info(`[${this.prefix}] ‚ÑπÔ∏è ${e}`,...t)}warn(e,...t){this.level<=m.WARN&&console.warn(`[${this.prefix}] ‚ö†Ô∏è ${e}`,...t)}error(e,t){this.level<=m.ERROR&&console.error(`[${this.prefix}] ‚ùå ${e}`,t)}group(e){console.group(`[${this.prefix}] ${e}`)}groupEnd(){console.groupEnd()}time(e){console.time(`[${this.prefix}] ${e}`)}timeEnd(e){console.timeEnd(`[${this.prefix}] ${e}`)}}("FineDeal"),f=new class{constructor(){this.MIN_CONFIDENCE=85,this.ACCESSORY_KEYWORDS=["case","cover","charger","cable","adapter","holder","stand","protector","screen guard","tempered glass","skin","pouch","sleeve","bag","strap","band","compatible","accessory","graphics card","gpu","graphic card"]}async findMatches(e,t){g.time("Product Matching"),g.group("Product Matching"),g.info(`Source: ${e.title}`),g.info(`Candidates: ${t.length}`);try{const r=t.filter(e=>e.numericPrice>=10&&e.title?.length>=5);g.info(`After validation: ${r.length} valid products`);const a=this.filterAccessories(e,r);if(g.info(`After accessory filter: ${a.length}`),0===a.length)return g.warn("No products after filtering"),[];const i=this.extractAttributes(e);g.info("Source attributes:",{model:i.model,storage:i.storage,brand:e.brand});const s=[];if(e.productNumber){const t=this.findProductNumberMatches(e,a);if(t.length>0)return g.info(`‚úÖ Level 0.5: ${t.length} product number matches - EARLY EXIT`),this.sortAndLimit(t)}if(e.productId){const t=this.findExactIdMatches(e,a);if(t.length>0)return g.info(`‚úÖ Level 1: ${t.length} exact ID matches - EARLY EXIT`),this.sortAndLimit(t)}const o=this.findBrandModelStorageMatches(e,i,a);if(s.push(...o),g.info(`‚úÖ Level 2: ${o.length} brand+model+storage matches`),s.length>=5)return g.info(`‚úÖ Early exit with ${s.length} high-confidence matches`),this.sortAndLimit(s);const n=this.findBrandModelMatches(e,i,a);if(s.push(...n),g.info(`‚úÖ Level 3: ${n.length} brand+model matches`),s.length<3){const t=this.findFuzzyMatches(e,i,a);s.push(...t),g.info(`‚úÖ Level 4: ${t.length} fuzzy matches`)}else g.info(`‚ö° Skipping fuzzy matching (already have ${s.length} matches)`);const c=this.sortAndLimit(s);return g.info(`üìä Total matches after filtering: ${c.length}`),c.length>0&&g.info("Top matches:",c.slice(0,2).map(e=>({title:e.title.substring(0,40),confidence:e.confidence,site:e.site}))),c}catch(e){return g.error("Matching error:",e),[]}finally{g.groupEnd(),g.timeEnd("Product Matching")}}findProductNumberMatches(e,t){const a=[];if(!e.productNumber)return a;const i={productNumber:e.productNumber||"",modelNumber:e.productNumber||"",partNumber:e.sku||"",sku:e.sku||"",asin:e.productId||"",confidence:100,source:"attribute"};for(const e of t)(e.productNumber||e.sku||e.productId)&&h(i,{productNumber:e.productNumber||"",modelNumber:e.productNumber||"",partNumber:e.sku||"",sku:e.sku||"",asin:e.productId||"",confidence:100,source:"attribute"})&&a.push({...e,confidence:99,matchLevel:r.EXACT,matchBadge:"üéØ EXACT",matchReason:`Product Number: ${e.productNumber||e.sku}`});return a}findExactIdMatches(e,t){return t.filter(t=>t.productId===e.productId).map(e=>({...e,confidence:100,matchLevel:r.EXACT_ID,matchBadge:"üéØ EXACT",matchReason:"Exact Product ID"}))}findBrandModelStorageMatches(e,t,a){const i=[];if(!t.model)return i;for(const e of a){if(!this.compareBrands(t,this.extractAttributes(e)))continue;const a=this.extractAttributes(e);this.compareModels(t.model,a.model)&&(t.storage&&a.storage?t.storage===a.storage?i.push({...e,confidence:95,matchLevel:r.EXACT,matchBadge:"üéØ EXACT",matchReason:`${a.model} ${a.storage}`}):i.push({...e,confidence:80,matchLevel:r.HIGH,matchBadge:"‚úì HIGH",matchReason:`${a.model} (different storage)`}):i.push({...e,confidence:85,matchLevel:r.HIGH,matchBadge:"‚úì HIGH",matchReason:`${a.model}`}))}return i}findBrandModelMatches(e,t,a){const i=[];if(!t.model)return i;for(const s of a){const a=this.extractAttributes(s);if(this.compareBrands(t,a)&&(a.model&&this.compareModels(t.model,a.model))){const t=this.calculateTextSimilarity(e.title,s.title);let o=Math.min(84,Math.max(70,Math.round(70+14*t)));const n=s.numericPrice/e.numericPrice;n>=.7&&n<=1.3&&(o=Math.min(95,o+10),g.debug(`Price boost: ${s.title.substring(0,30)} (ratio: ${n.toFixed(2)})`)),i.push({...s,confidence:o,matchLevel:r.MEDIUM,matchBadge:"‚âà MEDIUM",matchReason:`${a.model||"Similar model"}`,similarity:t})}}return i}findFuzzyMatches(e,t,a){const i=[];for(const s of a){const a=this.extractAttributes(s),o=this.compareBrands(t,a);if(!o)continue;const n=this.calculateTextSimilarity(e.title,s.title),c=this.hasCommonKeywords(e.title,s.title);if(n>=.4||o&&c&&n>=.3){let t=Math.min(69,Math.max(20,Math.round(20+49*n)));const a=s.numericPrice/e.numericPrice;a>=.7&&a<=1.3&&(t=Math.min(80,t+15),g.debug(`Fuzzy price boost: ${s.title.substring(0,30)} (ratio: ${a.toFixed(2)})`)),t>=this.MIN_CONFIDENCE&&i.push({...s,confidence:t,matchLevel:r.LOW,matchBadge:"~ RELATED",matchReason:`Similar product (${Math.round(100*n)}% match)`,similarity:n})}}return i}filterAccessories(e,t){const r=this.isAccessory(e.title),a=e.category,i=e.title.toLowerCase();return t.filter(e=>{if(r)return!0;const t=this.isAccessory(e.title),s=e.title.toLowerCase(),o="electronics-laptop"===a||/laptop|notebook/i.test(i),n="electronics-phone"===a||/phone|mobile|smartphone/i.test(i),c="electronics-tablet"===a||/tablet|ipad/i.test(i),l="electronics-gpu"===a||/graphics card|gpu|geforce|radeon/i.test(i),d="electronics-laptop"===e.category||/laptop|notebook/i.test(s),p="electronics-phone"===e.category||/phone|mobile|smartphone/i.test(s),u="electronics-tablet"===e.category||/tablet|ipad/i.test(s),h="electronics-gpu"===e.category||/graphics card|gpu|geforce|radeon/i.test(s);return o&&(p||u||h)?(g.debug(`Blocking: Laptop source vs ${e.category} candidate`),!1):n&&(d||u||h)?(g.debug(`Blocking: Phone source vs ${e.category} candidate`),!1):c&&(d||p||h)?(g.debug(`Blocking: Tablet source vs ${e.category} candidate`),!1):l&&(d||p||u)?(g.debug(`Blocking: GPU source vs ${e.category} candidate`),!1):!t})}isAccessory(e){const t=e.toLowerCase();return this.ACCESSORY_KEYWORDS.some(e=>t.includes(e))}extractAttributes(e){return{model:o(e.title),storage:n(e.title),ram:c(e.title),color:l(e.title),size:"",variant:"",brand:p(e.brand||"")}}compareBrands(e,t){const r=e.brand||"",a=t.brand||"";if(r&&a&&u(r,a))return g.debug(`Brand match: ${r} === ${a}`),!0;const i=(e.model||"").toLowerCase(),s=(t.model||"").toLowerCase();if(i&&s&&(i===s||i.includes(s)||s.includes(i)))return!0;const o=["iphone","samsung","galaxy","oneplus","xiaomi","redmi","mi","oppo","vivo","realme","pixel","poco","motorola","moto","nokia","asus","lenovo","dell","hp","acer","apple","macbook"];for(const e of o)if(i.includes(e)&&s.includes(e))return!0;const n=i.match(/\d+/g),c=s.match(/\d+/g);if(n&&c)for(const e of n)if(c.includes(e)&&e.length>=2)return!0;return!1}compareModels(e,t){if(!e||!t)return!1;const r=e.toLowerCase().replace(/[^a-z0-9]/g,""),a=t.toLowerCase().replace(/[^a-z0-9]/g,"");if(r===a)return!0;if(r.includes(a)||a.includes(r))return!0;const i=r.match(/\d+/g),s=a.match(/\d+/g);if(i&&s)for(const e of i)if(s.includes(e)&&e.length>=2)return!0;return!1}calculateTextSimilarity(e,t){const r=this.tokenize(e),a=this.tokenize(t),i=new Set(r),s=new Set(a),o=new Set([...i].filter(e=>s.has(e))),n=new Set([...i,...s]);return n.size>0?o.size/n.size:0}tokenize(e){const t=new Set(["the","a","an","and","or","for","with","from","to","in","on","at"]);return e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(e=>e.length>2&&!t.has(e))}hasCommonKeywords(e,t){const r=this.tokenize(e),a=this.tokenize(t);return r.filter(e=>a.includes(e)).length>=2}sortAndLimit(e,t=20){return e.filter(e=>e.confidence>=this.MIN_CONFIDENCE).sort((e,t)=>t.confidence-e.confidence).slice(0,t)}async findSimilarProducts(e,t){g.info("üîç Finding similar products...");const a=[],i=(e.brand||"").toLowerCase(),s=e.category?.toLowerCase()||"",o=e.title.toLowerCase(),n=o.match(/\b(black|white|blue|red|green|yellow|pink|purple|grey|gray|silver|gold|rose|midnight|starlight|coral|velvet|ocean)\b/i),c=n?n[0].toLowerCase():"",l=o.match(/\b(shade\s*)?(\d{1,3})\b|\b(fair|light|medium|dark|deep|ivory|beige|nude|natural)\b/i),d=l?l[0].toLowerCase():"";g.info("Similar product criteria:",{brand:i,category:s,color:c,shade:d});for(const e of t){const t=(e.brand||"").toLowerCase(),n=e.category?.toLowerCase()||"",l=e.title.toLowerCase();if(!t||!i||!t.includes(i.split(" ")[0]))continue;let p=20,u="Same brand";if(s&&n&&s===n){if(p+=15,u=`Same brand & category (${s})`,(s.includes("fashion")||s.includes("clothing"))&&c){const e=l.match(/\b(black|white|blue|red|green|yellow|pink|purple|grey|gray|silver|gold|rose|midnight|starlight|coral|velvet|ocean)\b/i);(e?e[0].toLowerCase():"")===c&&(p+=20,u=`Same brand, category & color (${c})`)}if(s.includes("beauty")&&d){const e=l.match(/\b(shade\s*)?(\d{1,3})\b|\b(fair|light|medium|dark|deep|ivory|beige|nude|natural)\b/i);(e?e[0].toLowerCase():"")===d&&(p+=25,u=`Same brand, category & shade (${d})`)}if(s.includes("electronics")||s.includes("smartphone")||s.includes("laptop")){const e=["pro","max","plus","lite","mini","ultra","air","5g","4g"],t=e.some(e=>o.includes(e)),r=e.some(e=>l.includes(e));if(t&&r){const t=e.find(e=>o.includes(e));t===e.find(e=>l.includes(e))&&(p+=10,u+=` + similar type (${t})`)}}}p>=30&&a.push({...e,confidence:p,matchLevel:r.SIMILAR,matchBadge:"üîó SIMILAR",matchReason:u})}const p=a.sort((e,t)=>t.confidence-e.confidence).slice(0,15);return g.info(`Found ${p.length} similar products`),p}},b=new class{constructor(){this.MIN_CONFIDENCE=70,this.MAX_RESULTS=8,this.WEIGHTS={BRAND:25,MODEL:30,SPECS:20,TITLE:15,CATEGORY:10},this.CATEGORY_KEYWORDS={laptop:["laptop","notebook","ultrabook","chromebook","macbook"],phone:["phone","smartphone","mobile","iphone","galaxy phone"],tablet:["tablet","ipad","tab s","surface go"],gpu:["graphics card","gpu","geforce","radeon","rtx","gtx"],accessory:["case","cover","charger","cable","adapter","protector","tempered glass"]}}async findMatches(e,t){g.time("Smart Matching v4.0"),g.group("üß† Smart Matcher v4.0"),g.info(`Source: ${e.title}`),g.info(`Total candidates: ${t.length}`);try{const r=this.preprocessCandidates(t);g.info(`‚úÖ Valid candidates: ${r.length}`);const a=this.detectCategory(e);g.info(`üì¶ Source category: ${a}`);const i=this.filterByCategory(e,a,r);if(g.info(`‚úÖ Category filtered: ${i.length}`),0===i.length)return g.warn("‚ö†Ô∏è No candidates after category filtering"),[];const s=this.extractFeatures(e);g.info("üîç Source features:",{brand:s.brand,model:s.model,storage:s.storage,ram:s.ram,tokens:s.tokens.slice(0,5).join(", ")});const o=[];for(const t of i){const r=this.extractFeatures(t),a=this.calculateScore(s,r,e,t);if(a.total>=this.MIN_CONFIDENCE){const e={...t,confidence:Math.round(a.total),matchLevel:this.getMatchLevel(a.total),matchBadge:this.getMatchBadge(a.total),matchReason:this.buildMatchReason(a,r),scoring:a};o.push(e)}}const n=o.sort((e,t)=>t.confidence-e.confidence).slice(0,this.MAX_RESULTS);return g.info(`‚úÖ Final matches: ${n.length}`),n.length>0&&g.info("üèÜ Top 3 matches:",n.slice(0,3).map(e=>({title:e.title.substring(0,50),confidence:e.confidence,brand:e.scoring?.brandScore,model:e.scoring?.modelScore,specs:e.scoring?.specsScore,site:e.site}))),n}catch(e){return g.error("‚ùå Smart matching error:",e),[]}finally{g.groupEnd(),g.timeEnd("Smart Matching v4.0")}}preprocessCandidates(e){return e.filter(e=>!(!e.title||e.title.length<5||e.numericPrice<10))}detectCategory(e){const t=e.title.toLowerCase();if(e.category){if(e.category.includes("laptop"))return"laptop";if(e.category.includes("phone"))return"phone";if(e.category.includes("tablet"))return"tablet";if(e.category.includes("gpu"))return"gpu"}for(const[e,r]of Object.entries(this.CATEGORY_KEYWORDS))for(const a of r)if(t.includes(a))return e;return"unknown"}filterByCategory(e,t,r){return"accessory"===t?r.filter(e=>"accessory"===this.detectCategory(e)):r.filter(e=>{const r=this.detectCategory(e);return"accessory"!==r&&("unknown"===t||"unknown"===r||t===r)})}extractFeatures(e){const t=e.title.toLowerCase(),r=p(e.brand||""),a=o(e.title),i=n(e.title),s=c(e.title),d=l(e.title),u=this.tokenize(e.title);return{brand:r,model:a,storage:i,ram:s,color:d,tokens:u,bigrams:this.generateNGrams(u,2),trigrams:this.generateNGrams(u,3),numbers:t.match(/\d+/g)?.map(e=>parseInt(e))||[],keywords:this.extractKeywords(t),titleLower:t}}tokenize(e){const t=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by"]);return e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(e=>e.length>1&&!t.has(e))}generateNGrams(e,t){const r=[];for(let a=0;a<=e.length-t;a++)r.push(e.slice(a,a+t).join(" "));return r}extractKeywords(e){const t=[],r=e.match(/\b(apple|samsung|oneplus|xiaomi|redmi|oppo|vivo|realme|pixel|poco|iphone|galaxy|macbook|dell|hp|lenovo|asus|acer|msi)\b/gi)||[];t.push(...r);const a=e.match(/\b([a-z0-9]+ (?:pro|plus|ultra|max|mini|lite|ti|super))\b/gi)||[];t.push(...a);const i=e.match(/\b(\d+(?:gb|tb|ghz|mp|inch|hz))\b/gi)||[];return t.push(...i),t.map(e=>e.toLowerCase())}calculateScore(e,t,r,a){const i=this.scoreBrand(e.brand,t.brand),s=this.scoreModel(e.model,t.model,e.tokens,t.tokens),o=this.scoreSpecs(e,t),n=this.scoreTitleSimilarity(e.tokens,t.tokens,e.bigrams,t.bigrams),c=this.scoreCategory(r.category,a.category),l=this.scorePriceProximity(r.numericPrice,a.numericPrice);return{brandScore:i,modelScore:s,specsScore:o,titleScore:n,categoryScore:c,priceScore:l,total:Math.min(100,i+s+o+n+c+l)}}scoreBrand(e,t){if(!e||!t)return 0;if(u(e,t))return this.WEIGHTS.BRAND;if(e.includes(t)||t.includes(e))return.7*this.WEIGHTS.BRAND;const r=e.split(/\s+/),a=t.split(/\s+/);return r.filter(e=>a.includes(e)&&e.length>2).length>0?.5*this.WEIGHTS.BRAND:0}scoreModel(e,t,r,a){if(!e||!t)return this.calculateTokenOverlap(r,a)*this.WEIGHTS.MODEL;const i=e.toLowerCase().replace(/[^a-z0-9]/g,""),s=t.toLowerCase().replace(/[^a-z0-9]/g,"");if(i===s)return this.WEIGHTS.MODEL;if(i.includes(s)||s.includes(i))return.8*this.WEIGHTS.MODEL;const o=this.stringSimilarity(i,s);return o>.6?this.WEIGHTS.MODEL*o:0}scoreSpecs(e,t){let r=0;return e.storage&&t.storage&&(e.storage===t.storage?r+=8:Math.abs(parseInt(e.storage)-parseInt(t.storage))<=128&&(r+=4)),e.ram&&t.ram&&(e.ram===t.ram?r+=8:Math.abs(parseInt(e.ram)-parseInt(t.ram))<=4&&(r+=4)),e.color&&t.color&&e.color.toLowerCase()===t.color.toLowerCase()&&(r+=4),r}scoreTitleSimilarity(e,t,r,a){return(.4*this.calculateTokenOverlap(e,t)+.6*this.calculateTokenOverlap(r,a))*this.WEIGHTS.TITLE}calculateTokenOverlap(e,t){if(0===e.length||0===t.length)return 0;const r=new Set(e),a=new Set(t),i=new Set([...r].filter(e=>a.has(e))),s=new Set([...r,...a]);return i.size/s.size}scoreCategory(e,t){return e&&t?e===t?this.WEIGHTS.CATEGORY:e.includes(t)||t.includes(e)?.7*this.WEIGHTS.CATEGORY:0:5}scorePriceProximity(e,t){if(0===e||0===t)return 0;const r=Math.max(e,t)/Math.min(e,t);return r<=1.2?5:r<=1.5?3:r>2?-2:0}stringSimilarity(e,t){if(e===t)return 1;if(0===e.length||0===t.length)return 0;const r=e.length>t.length?e:t;if(e.length,t.length,0===r.length)return 1;const a=this.levenshteinDistance(e,t);return(r.length-a)/r.length}levenshteinDistance(e,t){const r=[];for(let e=0;e<=t.length;e++)r[e]=[e];for(let t=0;t<=e.length;t++)r[0][t]=t;for(let a=1;a<=t.length;a++)for(let i=1;i<=e.length;i++)t.charAt(a-1)===e.charAt(i-1)?r[a][i]=r[a-1][i-1]:r[a][i]=Math.min(r[a-1][i-1]+1,r[a][i-1]+1,r[a-1][i]+1);return r[t.length][e.length]}getMatchLevel(e){return e>=90?r.EXACT:e>=80?r.HIGH:e>=70?r.MEDIUM:r.LOW}getMatchBadge(e){return e>=90?"üéØ EXACT":e>=80?"‚≠ê HIGH":e>=70?"‚úì MEDIUM":"~ LOW"}buildMatchReason(e,t){const r=[];if(e.brandScore>=20&&r.push(`Brand: ${t.brand}`),e.modelScore>=20&&r.push(`Model: ${t.model||"matched"}`),e.specsScore>=10){const e=[];t.storage&&e.push(t.storage),t.ram&&e.push(t.ram),e.length>0&&r.push(`Specs: ${e.join(", ")}`)}return e.titleScore>=10&&r.push("Similar title"),r.join(" ‚Ä¢ ")||"Matched"}};class y extends Error{constructor(e,t,r,a){super(e),this.name="FineDealError",this.code=t,this.site=r,this.details=a}}async function v(e,t,r="Operation timed out"){return Promise.race([e,new Promise((e,i)=>setTimeout(()=>i(new y(r,a.TIMEOUT)),t))])}const w=new class{async get(e){try{const t=(await chrome.storage.local.get(e))[e];return t?Date.now()-t.timestamp>t.ttl?(await this.delete(e),null):t.data:null}catch(e){return console.error("Cache get error:",e),null}}async set(e,t,r=3e5){try{await this.cleanExpired();const a={data:t,timestamp:Date.now(),ttl:r};await chrome.storage.local.set({[e]:a})}catch(e){console.error("Cache set error:",e)}}async delete(e){try{await chrome.storage.local.remove(e)}catch(e){console.error("Cache delete error:",e)}}async clear(){try{await chrome.storage.local.clear()}catch(e){console.error("Cache clear error:",e)}}async cleanExpired(){try{const e=await chrome.storage.local.get(null),t=[],r=Date.now();for(const a in e){const i=e[a];i.timestamp&&r-i.timestamp>i.ttl&&t.push(a)}t.length>0&&(await chrome.storage.local.remove(t),console.log(`Cleaned ${t.length} expired cache entries`));const a=Object.keys(e).length-t.length;if(a>100){const r=Object.keys(e).filter(e=>!t.includes(e)).sort((t,r)=>e[t].timestamp-e[r].timestamp).slice(0,a-100);await chrome.storage.local.remove(r),console.log(`Removed ${r.length} oldest cache entries`)}}catch(e){console.error("Cache clean error:",e)}}generateKey(e,t){return`cache:${e}:${this.hashString(t)}`}hashString(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t&=t;return Math.abs(t).toString(36)}};const k=document.getElementById("compare-btn"),E=document.getElementById("clear-cache-btn"),I=document.getElementById("current-product"),$=document.getElementById("results-section"),C=document.getElementById("progress-section"),x=document.getElementById("progress-text"),M=document.getElementById("stats-section"),S=document.getElementById("best-deal"),L=document.getElementById("total-savings"),P=document.getElementById("sites-searched");let A=null,T=!1;const R=document.getElementById("notify-switch");let N="",_="";function z(e,t){return`notify_enabled_${e}_${t}`}async function O(e,t,r){const a=t.slice(0,3);for(const t of a){const r=w.generateKey(e,t),a=await w.get(r);if(a&&a.length>0)return g.info(`${e}: CACHE HIT`),{site:e,products:a,successfulQuery:t}}const i=a.map(async(t,r)=>{try{const a=await B(e,t);if(a&&a.products.length>=2){const i=w.generateKey(e,t);return await w.set(i,a.products,3e5),{site:e,products:a.products,successfulQuery:t,queryIndex:r}}return null}catch(e){return null}}),s=(await Promise.all(i)).find(e=>null!==e);if(s)return{site:s.site,products:s.products,successfulQuery:s.successfulQuery};const o=t.slice(3,5);for(let t=0;t<o.length;t++){const r=o[t];try{const t=w.generateKey(e,r),a=await B(e,r);if(a&&a.products.length>0)return await w.set(t,a.products,3e5),{site:e,products:a.products,successfulQuery:r}}catch(e){}}return null}async function B(t,r,a){const i=e[t];var s;s=`Searching ${i.name}...`,x.textContent=s;try{const e=i.searchUrl+encodeURIComponent(r),a=await chrome.tabs.create({url:e,active:!1,selected:!1});if(!a.id)return null;await H(3500);try{await chrome.scripting.executeScript({target:{tabId:a.id},files:["content-script.js"]})}catch(e){return await chrome.tabs.remove(a.id),null}try{const e=await v(F(a.id,{type:"WAIT_FOR_PAGE_READY"}),5e3,`Page ready timeout for ${t}`);e?.ready||await H(1500)}catch(e){await H(1500)}const s=await v(F(a.id,{type:"GET_SEARCH_RESULTS"}),8e3,`Timeout for ${t}`);return await chrome.tabs.remove(a.id),s&&s.products&&s.products.length>0?(g.info(`${t}: Found ${s.products.length} products`),{site:t,products:s.products}):null}catch(e){return g.error(`Search error for ${t}:`,e),null}}function D(e){const t=e.includes("refresh");I.innerHTML=`\n    <div class="error">\n      <div class="error-icon">${t?"üîÑ":"‚ö†Ô∏è"}</div>\n      <p style="margin-bottom: ${t?"15px":"0"};">${e}</p>\n      ${t?'\n        <div style="margin-top: 10px; padding: 12px; background: #fff5f0; border-radius: 8px; border-left: 3px solid var(--orange);">\n          <p style="font-size: 12px; margin: 0; color: #666;">\n            <strong>Why?</strong> The extension loads when you install it, but existing tabs need a refresh to activate the price comparison features.\n          </p>\n        </div>\n      ':""}\n    </div>\n  `}async function F(e,t){return new Promise((r,a)=>{chrome.tabs.sendMessage(e,t,e=>{chrome.runtime.lastError?a(chrome.runtime.lastError):r(e)})})}function H(e){return new Promise(t=>setTimeout(t,e))}function G(e,t){return e.length>t?e.substring(0,t)+"...":e}R&&R.addEventListener("change",()=>{if(!N||!_)return;const e=z(_,N);localStorage.setItem(e,R.checked?"true":"false")}),function(){const e=window.injectProductInfo;window.injectProductInfo=function(t){N=t.productId,_=t.site,function(e,t){if(!R)return;const r=z(e,t),a="true"===localStorage.getItem(r);R.checked=a}(t.site,t.productId),e&&e(t)}}(),document.addEventListener("DOMContentLoaded",async()=>{try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t.id)return void D("Unable to access current tab");const r=t.url||"";if(!["amazon.in","flipkart.com","myntra.com","snapdeal.com","tatacliq.com","ajio.com","nykaa.com","croma.com","vijaysales.com"].some(e=>r.includes(e)))return void D("Please visit a product page on a supported e-commerce site (Amazon, Flipkart, etc.)");try{const r=await F(t.id,{type:"GET_PRODUCT_INFO"});r&&"unknown"!==r.site&&"error"!==r.site?(A=r,function(t){const r=e[t.site];I.innerHTML=`\n    <div class="product-card">\n      ${t.image?`<img src="${t.image}" alt="Product" class="product-img">`:""}\n      <div class="product-info">\n        <span class="site-badge ${r.badge}">${r.name}</span>\n        <h3 class="product-title">${G(t.title,100)}</h3>\n        <p class="product-price">${t.price}</p>\n      </div>\n    </div>\n  `}(r),k.disabled=!1):D("Please visit a product page on a supported e-commerce site")}catch(e){g.warn("Content script not responding:",e),D("Please refresh this page (F5) and try again. The extension needs to reload on this tab.")}}catch(e){g.error("Initialization error:",e),D("Failed to initialize extension")}}),k.addEventListener("click",async()=>{if(A&&!T){T=!0,k.disabled=!0;try{await async function(r){g.time("Comparison"),C.classList.remove("hidden"),$.innerHTML="";const a=function(e,t,r,a,i){const s=[];if(r)s.push(r),t&&s.push(`${t} ${r}`.trim());else{const r=[/\b([A-Z]{2}\d{2,3}[A-Z0-9]{2}\/[A-Z])\b/,/\bSM-([A-Z]\d{3,4}[A-Z]?)\b/,/\bSKU[-:\s]?([A-Z0-9]{5,10})\b/i,/\b([A-Z]{2,4}[-]?\d{4,6}[A-Z0-9]?)\b/];for(const a of r){const r=e.match(a);if(r){const e=r[1]||r[0];s.push(e),t&&s.push(`${t} ${e}`.trim());break}}if(i){const e=i.match(/\/dp\/([A-Z0-9]{10})|asin=([A-Z0-9]{10})/i);if(e){const t=e[1]||e[2];s.push(t)}}a&&/^[A-Z0-9]{6,15}$/i.test(a)&&(s.push(a),t&&s.push(`${t} ${a}`.trim()))}let l=e.replace(/\([^)]*\)/g,"").replace(/:[^:]*$/,"").replace(/\|.*/g,"").replace(/[-‚Äì‚Äî]/g," ").trim();const d=o(e),p=n(e),u=c(e),h=t||function(e){const t=["Apple","Samsung","Xiaomi","OnePlus","Realme","Vivo","Oppo","Nokia","iPhone","iPad","MacBook","Galaxy","Pixel","Mi","Redmi","Nike","Adidas","Puma","Reebok","Levi","Zara","H&M","Mango","Lakme","Maybelline","L'Oreal","MAC","Revlon","Nykaa","Sony","LG","Philips","Panasonic","Whirlpool","Bosch","IFB","Dell","HP","Lenovo","Asus","Acer","MSI","Boat","JBL","Bose","Sennheiser","Canon","Nikon"],r=e.toLowerCase();if(/(iphone|ipad|macbook|airpods|apple)/i.test(r))return"Apple";for(const e of t)if(r.includes(e.toLowerCase()))return e;return e.trim().split(/\s+/)[0]||""}(e);if(h&&d&&p&&s.push(`${h} ${d} ${p}`.trim()),h&&d&&u&&s.push(`${h} ${d} ${u}`.trim()),h&&d&&s.push(`${h} ${d}`.trim()),d&&p&&s.push(`${d} ${p}`.trim()),d&&s.push(d),h){const e=l.split(/\s+/).filter(e=>e.length>3&&!/^(with|from|for|the|and|that|this)$/i.test(e)).slice(0,3).join(" ");e&&s.push(`${h} ${e}`.trim())}const m=l.split(/\s+/).filter(e=>e.length>2).slice(0,5).join(" ");return m&&!s.includes(m)&&s.push(m),[...new Set(s)].filter(e=>e.length>=3&&e.length<=60)}(r.title,r.brand,r.productNumber,r.productId,r.url),l=t().filter(e=>e!==r.site),d=[];for(let e=0;e<l.length;e+=3)d.push(l.slice(e,e+3));const p=[];for(const e of d){const t=e.map(e=>O(e,a,l.length));(await Promise.all(t)).forEach(e=>{null!==e&&e.products.length>0&&p.push(e)}),e!==d[d.length-1]&&await H(500)}p.forEach(e=>{g.info(`${e.site}: ${e.products.length} products`)});const u=[];p.forEach(e=>{u.push(...e.products)});const h=function(e){const t=new Map;e.forEach(e=>{const r=t.get(e.site)||[];r.push(e),t.set(e.site,r)});const r=[];return t.forEach((e,t)=>{const a=function(e){const t=new Map;e.forEach(e=>{const r=function(e){let t=e.title.toLowerCase();return["black","white","red","blue","green","yellow","pink","purple","orange","grey","gray","brown","beige","navy","maroon","teal","olive","gold","silver","rose","mint","coral","cream","ivory","khaki","cyan","magenta"].forEach(e=>{t=t.replace(new RegExp(`\\b${e}\\b`,"gi"),"")}),t=t.replace(/\b(xs|s|m|l|xl|xxl|xxxl)\b/gi,""),t=t.replace(/\b\d+(\.\d+)?\s*(gb|tb|mb|kg|g|ml|l|inch|cm|mm)\b/gi,""),["variant","color","colour","size","pack of","combo"].forEach(e=>{t=t.replace(new RegExp(`\\b${e}\\b`,"gi"),"")}),t=t.replace(/\s+/g," ").trim(),`${(e.brand||"").toLowerCase()}:${t}`}(e),a=t.get(r)||[];a.push(e),t.set(r,a)});const r=[];return t.forEach(e=>{if(1===e.length)r.push(e[0]);else{const t=e.reduce((e,t)=>t.price<e.price?t:e);r.push(t)}}),r}(e);r.push(...a)}),r}(u),m=[];if(h.length>0)try{const e=await b.findMatches(r,h);if(m.push(...e),0===m.length){g.info("üîÑ Smart matcher found no results, trying fallback matcher...");const e=await f.findMatches(r,h);if(m.push(...e),0===m.length){const e=await f.findSimilarProducts(r,h);m.push(...e)}}const t=function(e){const t=["black","white","blue","red","green","yellow","pink","purple","grey","gray","silver","gold","rose","midnight","starlight","coral","velvet","ocean","space","titanium","natural","pro"],r=new Map;e.forEach(e=>{let a=e.title.toLowerCase();t.forEach(e=>{a=a.replace(new RegExp(`\\b${e}\\b`,"gi"),"").trim()}),a=a.replace(/\s+/g," ").trim();const i=`${e.site}|${e.brand}|${a}`;r.has(i)||r.set(i,[]),r.get(i).push(e)});const a=[];return r.forEach((e,t)=>{if(1===e.length)a.push(e[0]);else{const r=e.reduce((e,t)=>t.numericPrice<e.numericPrice?t:e);g.info(`Dedup: ${e.length} color variants for "${t.split("|")[2]}" on ${e[0].site} ‚Üí keeping cheapest at ‚Çπ${r.numericPrice}`),a.push(r)}}),a}(m);m.length=0,m.push(...t)}catch(e){g.error("Matching error:",e)}else g.warn("No products scraped from any site");g.info(`Total matches: ${m.length}`),C.classList.add("hidden"),function(r,a){const o=a.filter(e=>"out-of-stock"!==e.availability);o.length<a.length&&g.info(`Filtered out ${a.length-o.length} out-of-stock products`);const n=o.length>0?o:a;if(0===n.length)return M.classList.add("hidden"),void($.innerHTML=`\n      <div class="no-results">\n        <div class="icon">üîç</div>\n        <h3>No Matching Products Found</h3>\n        <p>We searched across ${t().length-1} major e-commerce sites</p>\n        <div style="margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px; text-align: left; font-size: 13px;">\n          <strong>Possible reasons:</strong>\n          <ul style="margin: 10px 0; padding-left: 20px;">\n            <li>Product is exclusive to ${e[r.site].name}</li>\n            <li>Different product name on other sites</li>\n            <li>Out of stock on competitor sites</li>\n            <li>Recently launched product</li>\n          </ul>\n          <p style="margin-top: 10px;"><strong>Tip:</strong> Try searching manually on other sites!</p>\n        </div>\n      </div>\n    `);const c=n[0],{diff:l,percent:d,isCheaper:p}=s(r.numericPrice,c.numericPrice),u=new Set(n.map(e=>e.site)).size;M.classList.remove("hidden"),S.textContent=e[c.site].name,L.textContent=p?`‚Çπ${l}`:"N/A",L.style.color=p?"var(--green)":"var(--text-light)",P.textContent=`${u}/${t().length-1}`;const h=n.every(e=>"SIMILAR"===e.matchLevel);let m="";h&&(m+=`\n      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center;">\n        <div style="font-size: 24px; margin-bottom: 5px;">üîó</div>\n        <div style="font-weight: 600; font-size: 16px;">Similar Products Found</div>\n        <div style="font-size: 13px; opacity: 0.9; margin-top: 5px;">\n          Exact match not available. Showing similar products from <strong>${r.brand||"same brand"}</strong>\n        </div>\n      </div>\n    `),!h&&p&&l>0&&(m+=`\n      <div class="savings-banner">\n        <div class="savings-amount">${i(l)}</div>\n        <div class="savings-text">Save ${d}% on ${e[c.site].name}!</div>\n      </div>\n    `),n.slice(0,10).forEach(t=>{const a=e[t.site],o=s(r.numericPrice,t.numericPrice),n="SIMILAR"===t.matchLevel,l=function(e,t,r={low:.3,high:2}){if(t<=0)return{isValid:!1,isSuspicious:!0,reason:"Invalid price (zero or negative)",confidence:0};if(e<=0)return{isValid:!0,isSuspicious:!1,confidence:.5};const a=t/e;if(a<r.low)return{isValid:!0,isSuspicious:!0,reason:`Suspiciously cheap (${Math.round(100*a)}% of original price)`,confidence:.3};if(a>r.high)return{isValid:!0,isSuspicious:!0,reason:`Suspiciously expensive (${Math.round(100*a)}% of original price)`,confidence:.4};const i=Math.abs(a-1);return{isValid:!0,isSuspicious:!1,confidence:Math.max(.5,1-i)}}(r.numericPrice,t.numericPrice),d=l.isSuspicious,p="limited-stock"===t.availability?'<span style="background: #FF9800; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">‚ö° LIMITED</span>':"";m+=`\n      <div class="result-card ${t.numericPrice!==c.numericPrice||h?"":"best-price"}">\n        ${t.image?`<img src="${t.image}" alt="Product" class="result-img">`:""}\n        <div class="result-info">\n          <div class="result-header">\n            <span class="site-badge ${a.badge}">${a.name}</span>\n            ${t.numericPrice!==c.numericPrice||h?"":'<span class="best-badge">BEST PRICE</span>'}\n            ${n?'<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">üîó SIMILAR</span>':""}\n            ${p}\n            ${d?'<span style="background: #FFA500; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;" title="'+l.reason+'">‚ö†Ô∏è SUSPICIOUS</span>':""}\n          </div>\n          <h4 class="result-title">${G(t.title,80)}</h4>\n          ${n?`<p style="font-size: 12px; color: #666; margin: 5px 0;">${t.matchReason}</p>`:""}\n          ${d?`<p style="font-size: 12px; color: #FF6B00; margin: 5px 0; font-weight: 500;">‚ö†Ô∏è ${l.reason}</p>`:""}\n          <div class="result-pricing">\n            <span class="result-price">${i(t.numericPrice)}</span>\n            ${h?"":`<span class="price-diff ${o.isCheaper?"cheaper":"expensive"}">\n              ${o.isCheaper?"‚Üì":"‚Üë"} ${o.percent}%\n            </span>`}\n          </div>\n          <div class="result-footer">\n            <span class="confidence">Match: ${t.confidence}%</span>\n            <div class="action-buttons">\n              <button class="btn-view" data-url="${t.url}">View Deal</button>\n              <button class="btn-copy" data-url="${t.url}" title="Copy link">üìã</button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `}),$.innerHTML=m,document.querySelectorAll(".btn-view").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.url;t&&chrome.tabs.create({url:t})})}),document.querySelectorAll(".btn-copy").forEach(e=>{e.addEventListener("click",async e=>{const t=e.target.dataset.url;if(t)try{await navigator.clipboard.writeText(t);const r=e.target,a=r.textContent;r.textContent="‚úì Copied!",r.style.background="var(--green)",setTimeout(()=>{r.textContent=a,r.style.background=""},2e3)}catch(e){g.error("Failed to copy link:",e)}})})}(r,m,m.length>0&&u.length),g.timeEnd("Comparison")}(A)}catch(e){g.error("Comparison error:",e),D("Failed to compare prices. Please try again.")}finally{T=!1,k.disabled=!1}}}),E.addEventListener("click",async()=>{try{await w.clear(),alert("Cache cleared! Next comparison will fetch fresh results.")}catch(e){g.error("Failed to clear cache:",e),alert("Failed to clear cache. Please try again.")}})})();
//# sourceMappingURL=popup.js.map